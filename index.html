<!doctype html>
<html lang="no" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="t_app">TS-kalkulator</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#00FFFF" id="themeColor">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <script>(function(){try{var s=localStorage.getItem('ts_theme')||'auto';document.documentElement.setAttribute('data-theme',s);var tc=document.getElementById('themeColor');var d=s==='dark'||(s==='auto'&&window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches);if(tc)tc.setAttribute('content',d?'#0b1220':'#00FFFF');}catch(e){}})();</script>
  <style>
    :root{--bg:#f8fafc;--card:#fff;--muted:#475569;--text:#0f172a;--ring:#e2e8f0;--brand:#00FFFF;--brandText:#041b1b;}
    @media (prefers-color-scheme:dark){
      :root{--bg:#0b1220;--card:#0f172a;--muted:#9aa8bf;--text:#ebf0f7;--ring:#1f2937;--brand:#00FFFF;--brandText:#002c2c;}
    }
    [data-theme="dark"]{--bg:#0b1220;--card:#0f172a;--muted:#9aa8bf;--text:#ebf0f7;--ring:#1f2937;--brand:#00FFFF;--brandText:#002c2c;}
    [data-theme="light"]{--bg:#f8fafc;--card:#fff;--muted:#475569;--text:#0f172a;--ring:#e2e8f0;--brand:#00FFFF;--brandText:#041b1b;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif}
    .wrap{max-width:820px;margin:0 auto;padding:14px 18px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:var(--brandText);padding:12px 22px;border-radius:16px;font-weight:800;border:1px solid #9efefe;box-shadow:0 1px 0 rgba(0,0,0,.06);font-size:28px}
    .pill-sm{font-size:16px;padding:8px 16px;border-radius:14px}
    .subtitle{color:var(--muted);font-size:16px;margin:10px 0 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-block;background:var(--brand);color:var(--brandText);text-decoration:none;padding:10px 14px;border-radius:12px;border:1px solid #9efefe;cursor:pointer}
    .ghost{background:transparent;border:1px solid var(--ring);color:var(--text)}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-top:12px}
    label{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--ring);font-size:20px;background:var(--card);color:var(--text)}
    input[type=range]{padding:0}
    .muted{color:var(--muted)}
    .big{font-size:48px;font-weight:900;letter-spacing:.5px}
    .footer{margin-top:18px;font-size:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;border-top:1px solid var(--ring);padding-top:8px}
    .small{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.35}
    .svgbox{background:var(--bg);border:1px solid var(--ring);border-radius:12px;padding:8px;overflow:auto;margin-top:8px}
    .warn{color:#b91c1c}

    /* Verkt√∏yvelger (TS / Fall) */
    .tool-switch {
      margin: 4px 0 10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .tool-switch-inner{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .tool-switch select {
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #9efefe;
      background:rgba(255,255,255,0.85);
      color:var(--brandText);
      font-size:14px;
    }

    /* Fallkalkulator-layout */
    #tool-fall { margin-top: 8px; }
    .fall-info,
    .fall-footer {
      font-size: 13px;
      color: var(--muted);
    }
    .fall-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .fall-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .fall-field label {
      font-weight: 700;
      font-size: 13px;
    }
    .fall-field small {
      font-size: 11px;
      color: var(--muted);
    }
    .mini-row {
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
    }
    .mini-row input{
      flex:1 1 auto;
    }
    .mini-row select{
      flex:0 0 auto;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--ring);
      background:var(--card);
      color:var(--text);
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Verkt√∏yvelger + spr√•kvelger i cyan pill -->
    <div class="tool-switch">
      <div class="pill pill-sm">
        <div class="tool-switch-inner">
          <span id="lbl_toolChoice">Velg kalkulator:</span>
          <select id="toolSelect" onchange="switchTool(this.value)">
            <option value="ts">TS-kalkulator</option>
            <option value="fall">Fallkalkulator</option>
          </select>
        </div>
      </div>
      <select id="lang" class="btn ghost" style="min-width:96px">
        <option value="no">NO</option><option value="en">EN</option><option value="sv">SV</option>
        <option value="dk">DK</option><option value="fi">FI</option><option value="de">DE</option>
      </select>
    </div>

    <!-- TS-kalkulator -->
    <div id="tool-ts">
      <div class="pill">TS-kalkulator</div>
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="subtitle" id="h_sub">Avlest vinkel p√• tommestokk omregnet til grader</div>
        <div class="row" style="margin:6px 0 4px">
          <button class="btn" id="qrBtn">QR</button>
          <button class="btn" id="installBtn">Installer</button>
          <button class="btn ghost" id="themeBtn">üåì</button>
          <button class="btn ghost" id="decBtn">0 des</button>
          <button class="btn ghost" id="hardRefreshBtn">Hard refresh</button>
        </div>
      </div>

      <section class="card">
        <label id="lbl_D">Avlest D (mm)</label>
        <input id="D" inputmode="decimal" value="760">
        <input id="sliderD" type="range" min="400" max="800" value="760" style="margin-top:12px">
        <div class="muted" id="rangeText" style="margin-top:6px">m√•leomr√•de 400-800mm</div>
        <div class="muted" style="margin-top:12px" id="lbl_angle">Vinkel (grader)</div>
        <div class="big" id="thetaTop">‚Äì</div>
      </section>

      <section class="card">
        <div class="subtitle" style="font-weight:800" id="guide_title">Bruksanvisning</div>
        <ul id="guide_list" class="muted"></ul>
        <div id="help_text" class="muted" style="margin:8px 0 6px"></div>
        <div class="svgbox">
          <!-- Hultafors-lignende tommestokk med 200 mm ledd -->
          <svg id="svgTech" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 940 360" width="100%">
            <defs>
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.25"/>
              </filter>
              <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
                <path d="M0 0L10 5L0 10Z" fill="#444"/>
              </marker>
            </defs>

            <!-- Kant for avlesning -->
            <g id="baseRuler" transform="translate(60,200)">
              <rect x="0" y="-10" width="820" height="20" rx="4" fill="#e6e6e6" stroke="#888" filter="url(#shadow)"/>
              <g fill="#666">
                <g>
                  <rect x="0" y="-10" width="2" height="10"/><text x="0" y="18" font-size="12" text-anchor="middle">0</text>
                  <rect x="100" y="-10" width="2" height="10"/><text x="100" y="18" font-size="12" text-anchor="middle">100</text>
                  <rect x="200" y="-10" width="2" height="10"/><text x="200" y="18" font-size="12" text-anchor="middle">200</text>
                  <rect x="300" y="-10" width="2" height="10"/><text x="300" y="18" font-size="12" text-anchor="middle">300</text>
                  <rect x="400" y="-10" width="2" height="10"/><text x="400" y="18" font-size="12" text-anchor="middle">400</text>
                  <rect x="500" y="-10" width="2" height="10"/><text x="500" y="18" font-size="12" text-anchor="middle">500</text>
                  <rect x="600" y="-10" width="2" height="10"/><text x="600" y="18" font-size="12" text-anchor="middle">600</text>
                  <rect x="700" y="-10" width="2" height="10"/><text x="700" y="18" font-size="12" text-anchor="middle">700</text>
                  <rect x="800" y="-10" width="2" height="10"/><text x="800" y="18" font-size="12" text-anchor="middle">800</text>
                </g>
              </g>
              <!-- Lesekant ved 0 mm -->
              <rect x="-2" y="-12" width="6" height="24" fill="#00FFFF" stroke="#088"/>
              <line x1="0" y1="-10" x2="0" y2="120" stroke="#444" stroke-dasharray="4 3"/>
              <text x="10" y="116" font-size="12">Kant for avlesning</text>
            </g>

            <!-- Tommestokk-gruppe, 200 mm + 200 mm ledd -->
            <g id="tsRoot" transform="translate(60,200)">
              <!-- Fast 0‚Äì200 mm segment langs kanten -->
              <g id="segBase">
                <rect x="-200" y="-10" width="200" height="20" rx="4" fill="#fffde8" stroke="#c9b36a" filter="url(#shadow)"/>
                <g stroke="#b99a4a">
                  <line x1="-200" y1="-10" x2="-200" y2="10"/>
                  <line x1="-150" y1="-8"  x2="-150" y2="8"/>
                  <line x1="-100" y1="-10" x2="-100" y2="10"/>
                  <line x1="-50"  y1="-8"  x2="-50"  y2="8"/>
                  <line x1="0"    y1="-10" x2="0"    y2="10"/>
                </g>
                <text x="-100" y="24" font-size="11" text-anchor="middle" fill="#7a642e">0‚Äì200 mm p√• kant</text>
              </g>

              <!-- 200 mm-ledd (vinkelen vi finner) -->
              <g id="joint200">
                <rect x="0" y="-10" width="200" height="20" rx="4" fill="#fffde8" stroke="#c9b36a" filter="url(#shadow)"/>
                <g stroke="#b99a4a">
                  <line x1="0"   y1="-10" x2="0"   y2="10"/>
                  <line x1="50"  y1="-8"  x2="50"  y2="8"/>
                  <line x1="100" y1="-10" x2="100" y2="10"/>
                  <line x1="150" y1="-8"  x2="150" y2="8"/>
                  <line x1="200" y1="-10" x2="200" y2="10"/>
                </g>
                <circle cx="0" cy="0" r="7" fill="#fff" stroke="#c9b36a"/>
                <circle cx="0" cy="0" r="3" fill="#c9b36a"/>
                <text x="90" y="-14" font-size="11" text-anchor="middle" fill="#7a642e">200 mm-ledd (Œ∏)</text>

                <!-- Ledd ved 400 mm-punktet, ogs√• 200 mm langt -->
                <g id="joint400" transform="translate(200,0)">
                  <rect x="0" y="-9" width="200" height="18" rx="4" fill="#fffde8" stroke="#c9b36a" filter="url(#shadow)"/>
                  <g stroke="#b99a4a">
                    <line x1="0"   y1="-9" x2="0"   y2="9"/>
                    <line x1="50"  y1="-7" x2="50"  y2="7"/>
                    <line x1="100" y1="-9" x2="100" y2="9"/>
                    <line x1="150" y1="-7" x2="150" y2="7"/>
                    <line x1="200" y1="-9" x2="200" y2="9"/>
                  </g>
                  <circle cx="0" cy="0" r="7" fill="#fff" stroke="#c9b36a"/>
                  <circle cx="0" cy="0" r="3" fill="#c9b36a"/>
                  <text x="100" y="-13" font-size="11" text-anchor="middle" fill="#7a642e">ledd ved 400 mm-punkt</text>
                  <!-- Spissen / kontaktpunkt mot kant -->
                  <circle cx="200" cy="0" r="5" fill="#00FFFF" stroke="#088"/>
                </g>
              </g>
            </g>

            <!-- D-m√•l (langs kanten) -->
            <g>
              <line x1="60" y1="250" x2="740" y2="250" stroke="#444" marker-start="url(#arrow)" marker-end="url(#arrow)"/>
              <line x1="60" y1="240" x2="60" y2="260" stroke="#444"/>
              <line x1="740" y1="240" x2="740" y2="260" stroke="#444"/>
              <text x="400" y="268" font-size="13" text-anchor="middle">Avlest D (mm) langs kanten</text>
            </g>
          </svg>
        </div>
      </section>

      <div class="footer muted">
        <div>¬© Stymparen</div>
        <div id="ver">4.2.1</div>
      </div>
      <div class="small">
        Hultafors¬Æ er et registrert varemerke tilh√∏rende Hultafors Group. Denne kalkulatoren er uavhengig og ikke tilknyttet, godkjent av eller sponset av Hultafors. ‚Äî
        Hultafors¬Æ is a registered trademark of Hultafors Group. This calculator is independent and not affiliated with, endorsed or sponsored by Hultafors.
      </div>
    </div>

    <!-- Fallkalkulator -->
    <div id="tool-fall" style="display:none;">
      <section class="card">
        <div class="pill" id="fallTitle">Fallkalkulator</div>
        <p class="fall-info" id="fallIntro" style="margin-top:8px;">
          Legg inn verdi i ett av feltene. Trykk Enter eller klikk utenfor feltet for √• oppdatere de andre.
        </p>

        <div class="fall-grid">
          <!-- Prosent -->
          <div class="fall-field">
            <label for="fallPercent" id="fallPercentLabel">Fall i prosent (%)</label>
            <small id="fallPercentHint">Eksempel: 2 betyr 2 % fall</small>
            <input id="fallPercent" type="number" step="0.001" inputmode="decimal" onchange="fallFromPercent()">
          </div>

          <!-- Grader -->
          <div class="fall-field">
            <label for="fallDegrees" id="fallDegreesLabel">Fall i grader (¬∞)</label>
            <small id="fallDegreesHint">Eksempel: 1.145 ‚âà 2 % fall</small>
            <input id="fallDegrees" type="number" step="0.001" inputmode="decimal" onchange="fallFromDegrees()">
          </div>

          <!-- Forhold 1:X -->
          <div class="fall-field">
            <label for="fallRatio" id="fallRatioLabel">Fallforhold (1 : X)</label>
            <small id="fallRatioHint">Skriv X. Eksempel: 50 for 1:50</small>
            <input id="fallRatio" type="text" inputmode="decimal" onchange="fallFromRatio()">
          </div>

          <!-- H√∏ydeforskjell / lengde med enhetsvelger -->
          <div class="fall-field">
            <label id="fallHLLabel">H√∏ydeforskjell og lengde</label>
            <small id="fallHLHint">Bruk samme strekning. Velg enhet for begge.</small>
            <div class="mini-row">
              <input id="fallHeightVal" type="number" step="0.1" inputmode="decimal" placeholder="H√∏yde" onchange="fallFromHeightLength()">
              <select id="fallHeightUnit" onchange="fallFromHeightLength()">
                <option value="mm">mm</option>
                <option value="cm">cm</option>
                <option value="m">m</option>
              </select>
            </div>
            <div class="mini-row" style="margin-top:6px;">
              <input id="fallLengthVal" type="number" step="0.01" inputmode="decimal" placeholder="Lengde" onchange="fallFromHeightLength()">
              <select id="fallLengthUnit" onchange="fallFromHeightLength()">
                <option value="m">m</option>
                <option value="cm">cm</option>
                <option value="mm">mm</option>
              </select>
            </div>
          </div>
        </div>

        <p class="fall-footer" id="fallFooter">
          Merk: 0 % fall gir uendelig fallforhold (ingen h√∏ydeforskjell).
        </p>
      </section>
    </div>
  </div>

  <!-- QR modal -->
  <div id="qrModal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999">
    <div class="card" style="max-width:92vw">
      <div class="row" style="justify-content:space-between"><h3 style="margin:0">QR-kode</h3><button class="btn ghost" id="qrClose">Lukk</button></div>
      <div class="muted" style="border:1px solid var(--ring);border-radius:10px;padding:8px 10px;margin-top:6px" id="qrUrlBox">https://wernerjakobsen-max.github.io/TS-Kalkulator/?v=4.2.1</div>
      <img id="qrImg" alt="QR-kode" style="display:block;margin:12px auto;border:1px solid var(--ring);max-width:72vw;height:auto">
      <div class="row"><button class="btn" id="copyUrl">Kopier lenke</button><a id="qrDownload" class="btn" download="ts-kalkulator-qr.png">Last ned PNG</a></div>
    </div>
  </div>

  <!-- Install modal -->
  <div id="instModal" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999">
    <div class="card" style="max-width:92vw">
      <div class="row" style="justify-content:space-between"><h3 style="margin:0">Installer app</h3><button class="btn ghost" id="instClose">Lukk</button></div>
      <div class="muted" style="margin-top:8px">
        Hvis install-knappen ikke dukker opp: <br>
        <b>Android/Chrome:</b> meny ‚ãÆ ‚Üí ¬´Legg til p√• startsiden¬ª.<br>
        <b>iOS (Safari):</b> delingsikonet ‚éã ‚Üí ¬´F√∏y til Hjem-skjerm¬ª.<br>
        <b>Desktop:</b> adresselinje ¬´Installer app¬ª-ikon eller meny.
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const CANONICAL="https://wernerjakobsen-max.github.io/TS-Kalkulator/?v=4.2.1";

  /* Data for TS-kalkulator (som 3.9.7b) */
  const X=[400,420,430,500,525,533,536,590,594,623,678,718,743,756,767,779,785,791,796,800];
  const Y=[0,8,10.5,31,38,41,42,59,60,70,90,107,120,128,135,145,150,157,166,180];

  const STR={
    no:{app:"TS-kalkulator",sub:"Avlest vinkel p√• tommestokk omregnet til grader",lblD:"Avlest D (mm)",range:"m√•leomr√•de 400-800mm",angle:"Vinkel (grader)",guide_title:"Bruksanvisning",guide:["Utstyr: plast tommestokk 2 m (f.eks. Hultafors), leddbredde ca. 15 mm.","Knekk f√∏rst 200 mm-leddet til √∏nsket vinkel (Œ∏).","Knekk deretter leddet ved 400 mm-punktet til 0-hj√∏rnet treffer tommestokken langs kanten.","Les av mm langs kanten (D). Skriv D inn her ‚Äì du f√•r vinkelen i 200-leddet.","Gyldig omr√•de: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"Illustrasjonen viser prinsippet: tommestokken ligger langs kanten. 200 mm-leddet st√•r i vinkel Œ∏. Leddet ved 400 mm b√∏yes slik at spissen (0-punktet) treffer kanten ved D. Denne D-verdien er kalibrert mot vinkelen Œ∏ i 200-leddet.",toolChoice:"Velg kalkulator:",fall_title:"Fallkalkulator",fall_intro:"Legg inn verdi i ett av feltene. Trykk Enter eller klikk utenfor feltet for √• oppdatere de andre.",fall_percent_label:"Fall i prosent (%)",fall_percent_hint:"Eksempel: 2 betyr 2 % fall",fall_deg_label:"Fall i grader (¬∞)",fall_deg_hint:"Eksempel: 1.145 ‚âà 2 % fall",fall_ratio_label:"Fallforhold (1 : X)",fall_ratio_hint:"Skriv X. Eksempel: 50 for 1:50",fall_hl_label:"H√∏ydeforskjell og lengde",fall_hl_hint:"Bruk samme strekning. Velg enhet for begge.",fall_footer:"Merk: 0 % fall gir uendelig fallforhold (ingen h√∏ydeforskjell)."},
    en:{app:"TS Calculator",sub:"Angle from folding ruler reading (mm ‚Üí degrees)",lblD:"Reading D (mm)",range:"measuring range 400‚Äì800 mm",angle:"Angle (degrees)",guide_title:"Instructions",guide:["Tool: 2 m plastic folding ruler (e.g., Hultafors), joint width ‚âà 15 mm.","First bend the 200 mm section to the desired angle (Œ∏).","Then bend the joint at the 400 mm point until the 0-corner meets the ruler edge.","Read D in mm along the edge. Enter D here ‚Äì you get the angle in the 200 mm section.","Valid range: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"The illustration shows the principle: the ruler lies along the edge. The 200 mm section is at angle Œ∏. The joint at 400 mm is bent so that the tip (0-point) meets the edge at D. This D value is calibrated to the angle Œ∏ in the 200 mm section.",toolChoice:"Select calculator:",fall_title:"Slope calculator",fall_intro:"Enter a value in one field. Press Enter or click outside the field to update the others.",fall_percent_label:"Slope in percent (%)",fall_percent_hint:"Example: 2 means 2% slope",fall_deg_label:"Slope in degrees (¬∞)",fall_deg_hint:"Example: 1.145 ‚âà 2% slope",fall_ratio_label:"Slope ratio (1 : X)",fall_ratio_hint:"Type X. Example: 50 for 1:50",fall_hl_label:"Height difference and length",fall_hl_hint:"Use the same run. Choose units for both.",fall_footer:"Note: 0% slope gives infinite slope ratio (no height difference)."},
    sv:{app:"TS-kalkylator",sub:"Avl√§st vinkel p√• tumstock omr√§knad till grader",lblD:"Avl√§st D (mm)",range:"m√§tomr√•de 400‚Äì800 mm",angle:"Vinkel (grader)",guide_title:"Bruksanvisning",guide:["Utrustning: plasttumstock 2 m (t.ex. Hultafors), led-bredd ca 15 mm.","Vik f√∂rst 200 mm-ledet till √∂nskad vinkel (Œ∏).","Vik sedan leden vid 400 mm-punkten tills 0-h√∂rnet m√∂ter tumstocken l√§ngs kanten.","L√§s av mm l√§ngs kanten (D). Skriv in D h√§r ‚Äì du f√•r vinkeln i 200-ledet.","Giltigt omr√•de: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"Illustrationen visar principen: tumstocken ligger l√§ngs kanten. 200 mm-ledet st√•r i vinkel Œ∏. Leddet vid 400 mm b√∂js s√• att spetsen (0-punkten) m√∂ter kanten vid D. Detta D-v√§rde √§r kalibrerat mot vinkeln Œ∏ i 200-ledet.",toolChoice:"V√§lj kalkylator:",fall_title:"Fallkalkylator",fall_intro:"Ange ett v√§rde i ett av f√§lten. Tryck Enter eller klicka utanf√∂r f√§ltet f√∂r att uppdatera de andra.",fall_percent_label:"Fall i procent (%)",fall_percent_hint:"Exempel: 2 betyder 2 % fall",fall_deg_label:"Fall i grader (¬∞)",fall_deg_hint:"Exempel: 1,145 ‚âà 2 % fall",fall_ratio_label:"Fallf√∂rh√•llande (1 : X)",fall_ratio_hint:"Skriv X. Exempel: 50 f√∂r 1:50",fall_hl_label:"H√∂jdskillnad och l√§ngd",fall_hl_hint:"Anv√§nd samma str√§cka. V√§lj enhet f√∂r b√•da.",fall_footer:"Obs: 0 % fall ger o√§ndligt fallf√∂rh√•llande (ingen h√∂jdskillnad)."},
    dk:{app:"TS-kalkulator",sub:"Afl√¶st vinkel p√• tommestok omregnet til grader",lblD:"Afl√¶st D (mm)",range:"m√•leomr√•de 400‚Äì800 mm",angle:"Vinkel (grader)",guide_title:"Brugsvejledning",guide:["Udstyr: plasttommestok 2 m (fx Hultafors), led-bredde ca. 15 mm.","B√∏j f√∏rst 200 mm-leddet til √∏nsket vinkel (Œ∏).","B√∏j derefter leddet ved 400 mm-punktet til 0-hj√∏rnet m√∏der tommestokken langs kanten.","Afl√¶s mm langs kanten (D). Indtast D her ‚Äì du f√•r vinklen i 200-leddet.","Gyldigt omr√•de: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"Illustrationen viser princippet: tommestokken ligger langs kanten. 200 mm-leddet st√•r i vinkel Œ∏. Leddet ved 400 mm b√∏jes, s√• spidsen (0-punktet) m√∏der kanten ved D. Dette D er kalibreret imod vinklen Œ∏ i 200-leddet.",toolChoice:"V√¶lg lommeregner:",fall_title:"Fald-kalkulator",fall_intro:"Indtast en v√¶rdi i √©t felt. Tryk Enter eller klik udenfor feltet for at opdatere de andre.",fall_percent_label:"Fald i procent (%)",fall_percent_hint:"Eksempel: 2 betyder 2 % fald",fall_deg_label:"Fald i grader (¬∞)",fall_deg_hint:"Eksempel: 1,145 ‚âà 2 % fald",fall_ratio_label:"Faldforhold (1 : X)",fall_ratio_hint:"Skriv X. F.eks. 50 for 1:50",fall_hl_label:"H√∏jde-forskel og l√¶ngde",fall_hl_hint:"Brug samme str√¶kning. V√¶lg enhed for begge.",fall_footer:"Bem√¶rk: 0 % fald giver uendeligt faldforhold (ingen h√∏jdeforskel)."},
    fi:{app:"TS-laskin",sub:"Taittomitan lukema muunnettuna asteiksi",lblD:"Lukema D (mm)",range:"mittausalue 400‚Äì800 mm",angle:"Kulma (astetta)",guide_title:"K√§ytt√∂ohje",guide:["V√§line: 2 m muovinen taitettava mitta (esim. Hultafors), nivelleveys n. 15 mm.","Taivuta ensin 200 mm osa haluttuun kulmaan (Œ∏).","Taivuta sitten 400 mm kohdan nivelt√§, kunnes 0-kulma osuu mittaan reunan kohdalla.","Lue millimetrit reunaa pitkin (D). Sy√∂t√§ D t√§h√§n ‚Äì saat kulman 200 mm osassa.","Sallittu alue: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"Kuva havainnollistaa periaatteen: mitta lep√§√§ reunan suuntaisesti. 200 mm osa on kulmassa Œ∏. 400 mm kohdan nivelt√§ taivutetaan, kunnes k√§rki (0-piste) osuu reunaan kohdassa D. T√§m√§ D-arvo on kalibroitu kulmaan Œ∏ 200 mm osassa.",toolChoice:"Valitse laskin:",fall_title:"Kaato-laskin",fall_intro:"Sy√∂t√§ arvo johonkin kentt√§√§n. Paina Enter tai klikkaa kent√§n ulkopuolelle p√§ivitt√§√§ksesi muut.",fall_percent_label:"Kaato prosentteina (%)",fall_percent_hint:"Esim.: 2 tarkoittaa 2 % kaatoa",fall_deg_label:"Kaato asteina (¬∞)",fall_deg_hint:"Esim.: 1,145 ‚âà 2 % kaato",fall_ratio_label:"Kaatosuhde (1 : X)",fall_ratio_hint:"Kirjoita X. Esim.: 50 vastaa 1:50",fall_hl_label:"Korkeusero ja pituus",fall_hl_hint:"K√§yt√§ samaa matkaa. Valitse yksikk√∂ molemmille.",fall_footer:"Huom: 0 % kaato antaa √§√§rett√∂m√§n suhteen (ei korkeuseroa)."},
    de:{app:"TS-Rechner",sub:"Abgelesener Winkel am Gliederma√üstab in Grad",lblD:"Ablesung D (mm)",range:"Messbereich 400‚Äì800 mm",angle:"Winkel (Grad)",guide_title:"Bedienungsanleitung",guide:["Werkzeug: 2-m-Gliederma√üstab aus Kunststoff (z. B. Hultafors), Gelenkbreite ca. 15 mm.","Zuerst 200-mm-Glied auf gew√ºnschten Winkel (Œ∏) biegen.","Dann das Glied bei 400 mm so biegen, bis die 0-mm-Ecke den Ma√üstab entlang der Kante ber√ºhrt.","In mm entlang der Kante ablesen (D). Geben Sie D hier ein ‚Äì Sie erhalten den Winkel im 200-mm-Glied.","G√ºltiger Bereich: 400‚Äì800 mm (400‚âà0¬∞, 800‚âà180¬∞)."],help_text:"Die Illustration zeigt das Prinzip: Der Ma√üstab liegt entlang der Kante. Das 200-mm-Glied steht im Winkel Œ∏. Das Glied bei 400 mm wird so gebogen, dass die Spitze (0-Punkt) die Kante bei D ber√ºhrt. Dieser D-Wert ist auf den Winkel Œ∏ im 200-mm-Glied kalibriert.",toolChoice:"Rechner w√§hlen:",fall_title:"Gef√§lle-Rechner",fall_intro:"Geben Sie einen Wert in ein Feld ein. Dr√ºcken Sie Enter oder klicken Sie au√üerhalb, um die anderen zu aktualisieren.",fall_percent_label:"Gef√§lle in Prozent (%)",fall_percent_hint:"Beispiel: 2 bedeutet 2 % Gef√§lle",fall_deg_label:"Gef√§lle in Grad (¬∞)",fall_deg_hint:"Beispiel: 1,145 ‚âà 2 % Gef√§lle",fall_ratio_label:"Gef√§lle-Verh√§ltnis (1 : X)",fall_ratio_hint:"X eingeben. Beispiel: 50 f√ºr 1:50",fall_hl_label:"H√∂henunterschied und L√§nge",fall_hl_hint:"Gleiche Strecke verwenden. Einheit f√ºr beide w√§hlen.",fall_footer:"Hinweis: 0 % Gef√§lle ergibt ein unendliches Verh√§ltnis (kein H√∂henunterschied)."}
  };

  function pchipSlopes(x,y){
    const n=x.length,h=new Array(n-1),d=new Array(n-1);
    for(let i=0;i<n-1;i++){h[i]=x[i+1]-x[i];d[i]=(y[i+1]-y[i])/h[i];}
    const m=new Array(n); m[0]=d[0]; m[n-1]=d[n-2];
    for(let i=1;i<n-1;i++){
      if(d[i-1]*d[i]<=0) m[i]=0;
      else {const w1=2*h[i]+h[i-1],w2=h[i]+2*h[i-1]; m[i]=(w1+w2)/(w1/d[i-1]+w2/d[i]);}
    }
    for(let i=0;i<n-1;i++){
      if(d[i]===0){m[i]=0; m[i+1]=0;}
      else {
        const a=m[i]/d[i],b=m[i+1]/d[i],s=a*a+b*b;
        if(s>9){const t=3/Math.sqrt(s); m[i]=t*a*d[i]; m[i+1]=t*b*d[i];}
      }
    }
    return m;
  }
  const M=pchipSlopes(X,Y);
  function pchipEval(xq){
    const n=X.length; if(xq<X[0]||xq>X[n-1])return null;
    let i=0,j=n-1; while(j-i>1){const k=(i+j)>>1; if(X[k]<=xq)i=k; else j=k;}
    const h=X[i+1]-X[i],t=(xq-X[i])/h;
    const h00=(1+2*t)*(1-t)*(1-t),h10=t*(1-t)*(1-t),h01=t*t*(3-2*t),h11=t*t*(t-1);
    return h00*Y[i]+h10*h*M[i]+h01*Y[i+1]+h11*h*M[i+1];
  }

  const LANG_KEY='ts_lang', DEC_KEY='ts_dec';
  const themeEl=document.documentElement,themeKey='ts_theme',themeColorTag=document.getElementById('themeColor');

  function applyTheme(v){
    themeEl.setAttribute('data-theme',v);
    try{localStorage.setItem(themeKey,v);}catch(e){}
    if(themeColorTag)themeColorTag.setAttribute('content',(v==='dark')?'#0b1220':'#00FFFF');
  }
  function toggleTheme(){
    const cur=themeEl.getAttribute('data-theme')||'auto';
    applyTheme(cur==='dark'?'light':cur==='light'?'auto':'dark');
  }
  function setLang(c){
    try{localStorage.setItem(LANG_KEY,c);}catch(e){}
    applyLang(c);
  }
  function getLang(){
    try{return localStorage.getItem(LANG_KEY)||'no';}catch(e){return'no';}
  }
  function getDec(){
    try{return parseInt(localStorage.getItem(DEC_KEY)||'0',10);}catch(e){return 0;}
  }
  function setDec(n){
    try{localStorage.setItem(DEC_KEY,String(n));}catch(e){}
    updateDecBtn(); render();
  }
  function toggleDec(){setDec(getDec()===0?1:0);}
  function updateDecBtn(){ const b=$('decBtn'); if(b)b.textContent=(getDec()===0?'0 des':'1 des'); }
  function Fdeg(v){const d=getDec(); return (d===0?Math.round(v):v.toFixed(d))+'¬∞';}

  function applyLang(c){
    const S=(STR[c]||STR.no);
    document.title = S.app || "TS-kalkulator";
    const h_sub=$('h_sub'),lbl_D=$('lbl_D'),rangeText=$('rangeText'),lbl_angle=$('lbl_angle'),
          guide_title=$('guide_title'),guide_list=$('guide_list'),
          help_text=$('help_text'),toolChoice=$('lbl_toolChoice');

    if(h_sub)h_sub.textContent=S.sub;
    if(lbl_D)lbl_D.textContent=S.lblD;
    if(rangeText)rangeText.textContent=S.range;
    if(lbl_angle)lbl_angle.textContent=S.angle;
    if(guide_title)guide_title.textContent=S.guide_title;
    if(guide_list){
      guide_list.innerHTML='';
      (S.guide||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; guide_list.appendChild(li);});
    }
    if(help_text)help_text.textContent=S.help_text||"";
    if(toolChoice)toolChoice.textContent=S.toolChoice||"Velg kalkulator:";

    // Fallkalkulator-tekster
    const fallTitle=$('fallTitle'),
          fallIntro=$('fallIntro'),
          fallPercentLabel=$('fallPercentLabel'),
          fallPercentHint=$('fallPercentHint'),
          fallDegreesLabel=$('fallDegreesLabel'),
          fallDegreesHint=$('fallDegreesHint'),
          fallRatioLabel=$('fallRatioLabel'),
          fallRatioHint=$('fallRatioHint'),
          fallHLLabel=$('fallHLLabel'),
          fallHLHint=$('fallHLHint'),
          fallFooter=$('fallFooter');

    if(fallTitle)fallTitle.textContent=S.fall_title||"Fallkalkulator";
    if(fallIntro)fallIntro.textContent=S.fall_intro||"Legg inn verdi i ett av feltene. Trykk Enter eller klikk utenfor feltet for √• oppdatere de andre.";
    if(fallPercentLabel)fallPercentLabel.textContent=S.fall_percent_label||"Fall i prosent (%)";
    if(fallPercentHint)fallPercentHint.textContent=S.fall_percent_hint||"Eksempel: 2 betyr 2 % fall";
    if(fallDegreesLabel)fallDegreesLabel.textContent=S.fall_deg_label||"Fall i grader (¬∞)";
    if(fallDegreesHint)fallDegreesHint.textContent=S.fall_deg_hint||"Eksempel: 1.145 ‚âà 2 % fall";
    if(fallRatioLabel)fallRatioLabel.textContent=S.fall_ratio_label||"Fallforhold (1 : X)";
    if(fallRatioHint)fallRatioHint.textContent=S.fall_ratio_hint||"Skriv X. Eksempel: 50 for 1:50";
    if(fallHLLabel)fallHLLabel.textContent=S.fall_hl_label||"H√∏ydeforskjell og lengde";
    if(fallHLHint)fallHLHint.textContent=S.fall_hl_hint||"Bruk samme strekning. Velg enhet for begge.";
    if(fallFooter)fallFooter.textContent=S.fall_footer||"Merk: 0 % fall gir uendelig fallforhold (ingen h√∏ydeforskjell).";
  }

  /* Dynamisk illustrasjon ‚Äì to 200 mm ledd:
     - 200 mm-ledd st√•r i vinkel Œ∏ (graden fra kalkulatoren)
     - leddet ved 400 mm-punktet speiles slik at spissen havner p√• D
     - hele tommestokken skyves langs kanten slik at 0-punktet treffer D */
  function updateIllustration(deg){
    const tsRoot=$('tsRoot');
    const joint200=$('joint200');
    const joint400=$('joint400');
    const Dinput=$('D');
    if(!tsRoot || !joint200 || !joint400 || !Dinput) return;

    const Dval=parseFloat(String(Dinput.value).replace(',','.'));

    if(!Number.isFinite(deg) || !Number.isFinite(Dval)){
      // Fallback-posisjon
      tsRoot.setAttribute('transform','translate(60,200)');
      joint200.setAttribute('transform','rotate(-65)');
      joint400.setAttribute('transform','translate(200,0) rotate(130)');
      return;
    }

    // 1) 200 mm-leddet: vinkel Œ∏ opp fra kanten ‚Üí -Œ∏ i SVG
    const thetaDeg = deg;
    const thetaSvgDeg = -thetaDeg;
    const thetaRad = thetaDeg * Math.PI / 180;

    joint200.setAttribute('transform','rotate('+thetaSvgDeg+')');

    // 2) Leddet ved 400 mm-punktet:
    //    Vi bruker en enkel symmetrisk modell:
    //    - absolutt vinkel for 200-leddet (matematisk) = +Œ∏
    //    - absolutt vinkel for 400-leddet (matematisk) = -Œ∏
    //    I SVG: 200-ledd = -Œ∏, 400-ledd = +Œ∏
    //    joint400 ligger inne i joint200 (-Œ∏), s√• relativ rotasjon = (+Œ∏) - (-Œ∏) = 2Œ∏.
    const rel400Deg = 2*thetaDeg;
    joint400.setAttribute('transform','translate(200,0) rotate('+rel400Deg+')');

    // 3) Spissens lokale x-koordinat i tsRoot-koordinater:
    //    to ledd √† 200 mm, absolutte matematiske vinkler +Œ∏ og -Œ∏
    //    x_tip_local = 200 cos Œ∏ + 200 cos Œ∏ = 400 cos Œ∏
    const tipLocalX = 400 * Math.cos(thetaRad);

    // 4) Vi vil at spissen skal havne p√• D mm langs kanten (baseRuler),
    //    hvor baseRuler sitt 0 ligger p√• x=60.
    //    tsRoot har translajon (60 + Tx, 200) => 60 + Tx + tipLocalX = 60 + D
    //    => Tx = D - tipLocalX
    const Tx = Dval - tipLocalX;

    tsRoot.setAttribute('transform','translate('+(60+Tx)+',200)');
  }

  function render(){
    const thetaTop=$('thetaTop'),rangeText=$('rangeText'),sliderD=$('sliderD'),inp=$('D');
    if(!thetaTop||!rangeText||!sliderD||!inp)return;
    const D=parseFloat(String(inp.value).replace(',','.'));
    if(!Number.isFinite(D)){
      thetaTop.textContent='‚Äì';
      updateIllustration(NaN);
      return;
    }
    sliderD.value=String(Math.max(400,Math.min(800,D)));
    const deg=pchipEval(D);
    if(deg==null){
      rangeText.classList.add('warn');
      thetaTop.textContent='‚Äì';
      updateIllustration(NaN);
    }else{
      rangeText.classList.remove('warn');
      thetaTop.textContent=Fdeg(deg);
      updateIllustration(deg);
    }
  }

  function openQR(){
    const url=CANONICAL, enc=encodeURIComponent(url);
    const box=$('qrUrlBox'),img=$('qrImg'),a=$('qrDownload'),modal=$('qrModal');
    if(box)box.textContent=url;
    if(img){img.src=`https://api.qrserver.com/v1/create-qr-code/?size=512x512&margin=10&data=${enc}`;}
    if(a && img)a.href=img.src;
    if(modal)modal.style.display='flex';
  }
  function closeQR(){const m=$('qrModal'); if(m)m.style.display='none';}
  function copyUrl(){
    if(!navigator.clipboard)return;
    navigator.clipboard.writeText(CANONICAL).then(()=>{
      const b=$('copyUrl'); if(!b)return;
      b.textContent='Kopiert!'; setTimeout(()=>{b.textContent='Kopier lenke';},1200);
    }).catch(()=>{});
  }

  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;});
  async function tryInstall(){
    if(deferredPrompt){await deferredPrompt.prompt();deferredPrompt=null;return;}
    const m=$('instModal'); if(m)m.style.display='flex';
  }

  /* Verkt√∏yvelger: TS / Fall */
  function switchTool(tool){
    const ts=$('tool-ts'),fall=$('tool-fall');
    if(!ts||!fall)return;
    if(tool==='fall'){ts.style.display='none';fall.style.display='block';}
    else{ts.style.display='block';fall.style.display='none';}
  }

  /* Fallkalkulator ‚Äì hjelpefunksjoner */
  function fallParseInput(id){
    const el=$(id); if(!el)return NaN;
    let raw=el.value.trim(); if(!raw)return NaN;
    raw=raw.replace(",",".");
    return parseFloat(raw);
  }
  function fallSetNumber(id,value,decimals){
    const el=$(id); if(!el||!isFinite(value))return;
    el.value=value.toFixed(decimals);
  }
  function fallSetText(id,value){
    const el=$(id); if(!el)return;
    el.value=value;
  }

  /* Fallkalkulator ‚Äì kjerne (stigning = h√∏yde / lengde) */
  function fallUpdateAll(stigning){
    if(!isFinite(stigning)||stigning<0)return;
    fallSetNumber("fallPercent",stigning*100,3);
    fallSetNumber("fallDegrees",Math.atan(stigning)*180/Math.PI,3);
    if(stigning===0){fallSetText("fallRatio","‚àû");}
    else{
      const ratio=1/stigning;
      fallSetText("fallRatio",ratio.toFixed(3).replace(/\.?0+$/,""));
    }
  }

  function fallFromPercent(){
    const p=fallParseInput("fallPercent"); if(isNaN(p))return;
    const s=p/100; fallUpdateAll(s);
  }
  function fallFromDegrees(){
    const d=fallParseInput("fallDegrees"); if(isNaN(d))return;
    const s=Math.tan(d*Math.PI/180); fallUpdateAll(s);
  }
  function fallFromRatio(){
    const el=$("fallRatio"); if(!el)return;
    let raw=el.value.trim(); if(!raw)return;
    if(raw.indexOf(":")>=0){const parts=raw.split(":"); raw=parts[1]||parts[0];}
    raw=raw.replace(",",".");
    const r=parseFloat(raw); if(!isFinite(r)||r<=0)return;
    const s=1/r; fallUpdateAll(s);
  }

  function unitToMeters(value,unit){
    if(!isFinite(value))return NaN;
    if(unit==="mm")return value/1000;
    if(unit==="cm")return value/100;
    if(unit==="m")return value;
    return NaN;
  }

  function fallFromHeightLength(){
    const hVal=fallParseInput("fallHeightVal");
    const LVal=fallParseInput("fallLengthVal");
    const hUnitEl=$("fallHeightUnit"),LUnitEl=$("fallLengthUnit");
    const hUnit=hUnitEl?hUnitEl.value:"mm";
    const LUnit=LUnitEl?LUnitEl.value:"m";
    if(isNaN(hVal)||isNaN(LVal))return;
    const hM=unitToMeters(hVal,hUnit);
    const LM=unitToMeters(LVal,LUnit);
    if(!isFinite(hM)||!isFinite(LM)||LM<=0)return;
    const s=hM/LM; fallUpdateAll(s);
  }

  document.addEventListener('DOMContentLoaded',()=>{
    const langSel=$('lang'); const cur=getLang();
    if(langSel)langSel.value=cur;
    applyLang(cur);
    if(langSel){langSel.addEventListener('change',(e)=>{setLang(e.target.value);});}
    updateDecBtn();

    const decBtn=$('decBtn'); if(decBtn)decBtn.addEventListener('click',toggleDec);
    const themeBtn=$('themeBtn'); if(themeBtn)themeBtn.addEventListener('click',toggleTheme);

    const Dinput=$('D'); if(Dinput)Dinput.addEventListener('input',render);
    const sliderD=$('sliderD'); if(sliderD)sliderD.addEventListener('input',e=>{Dinput.value=e.target.value;render();});

    const qrBtn=$('qrBtn'); if(qrBtn)qrBtn.addEventListener('click',openQR);
    const qrClose=$('qrClose'); if(qrClose)qrClose.addEventListener('click',closeQR);
    const copyBtn=$('copyUrl'); if(copyBtn)copyBtn.addEventListener('click',copyUrl);

    const instBtn=$('installBtn'); if(instBtn)instBtn.addEventListener('click',tryInstall);
    const instClose=$('instClose'); if(instClose)instClose.addEventListener('click',()=>{const m=$('instModal');if(m)m.style.display='none';});

    const hardBtn=$('hardRefreshBtn');
    if(hardBtn)hardBtn.addEventListener('click', async ()=>{
      try{
        if('caches' in window){const names=await caches.keys(); await Promise.all(names.map(n=>caches.delete(n))); }
        if('serviceWorker' in navigator){const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister()));}
      }catch(e){}
      location.href=CANONICAL;
    });

    render();
    const ver=$('ver'); if(ver)ver.textContent='4.2.1';
  });

  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js');});
  }
</script>
</body>
</html>
