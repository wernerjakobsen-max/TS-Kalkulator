
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TS-kalkulator – Lister Blikk</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#00FFFF">
  <link rel="icon" href="icon-192.png">
  <style>
    :root { --bg:#f8fafc; --card:#fff; --muted:#64748b; --text:#0f172a; --ring:#e2e8f0; --brand:#00FFFF; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px 20px}
    .h1{font-weight:700;font-size:clamp(20px,3.2vw,28px)}
    .muted{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
    input,button{font:inherit}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--ring);font-size:16px}
    input[type=range]{padding:0}
    .out{display:grid;gap:16px}
    @media(min-width:900px){.out{grid-template-columns:repeat(2,1fr)}}
    .big{font-size:28px;font-weight:700;margin-top:4px}
    .miniangle{margin-top:8px;font-size:13px;color:#0f172a;background:#e6ffff;display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #a0fefe}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--ring)}
    thead th{position:sticky;top:0;background:#e6ffff}
    .hi{background:#fffbea}
    .footer{margin-top:24px;font-size:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;border-top:1px solid var(--ring);padding-top:8px}
    .btn{display:inline-block;background:var(--brand);color:#000;text-decoration:none;padding:10px 14px;border-radius:10px;border:1px solid #a0fefe;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px}
    .badge{display:inline-block;background:var(--brand);color:#000;border:1px solid #a0fefe;padding:4px 8px;border-radius:999px;font-size:12px}
    .angle-inline { display:none; font-size:13px; color:var(--muted); }
    @media(max-width:700px){
      .col-angle { display:none; }
      .angle-inline { display:block; }
      thead { display:none; }
      table, tbody, tr, td { display:block; width:100%; }
      tr { border-bottom:1px solid var(--ring); padding:6px 0; }
      td { display:flex; justify-content:space-between; align-items:baseline; border:none; padding:4px 0; }
      td:first-child { display:block; }
    }
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{background:#fff;border:1px solid var(--ring);border-radius:16px;max-width:560px;width:100%;padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal h3{margin:0;font-size:18px}
    .close{background:#fff;border:1px solid var(--ring);border-radius:10px;padding:6px 10px;cursor:pointer}
    .qr-canvas{display:block;margin:12px auto;border:1px solid var(--ring);}
    .row-tight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .url-input{flex:1;min-width:200px}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div class="brand">
        <img src="logo-lister-blikk.png" srcset="logo-lister-blikk.png 1x, logo-lister-blikk@2x.png 2x" alt="Lister Blikk">
        <div>
          <div class="h1">TS-kalkulator <span class="badge">Lister Blikk</span></div>
          <div class="muted">Tommestokk-vinkler fra mm-avlesning (kalibrert)</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="qrBtn">QR</button>
        <button class="btn" id="installBtn" hidden>Installer</button>
      </div>
    </header>

    <section class="grid" style="margin-top:16px">
      <div class="card">
        <label>Avlest D (mm)</label>
        <input id="D" inputmode="decimal" value="760">
        <input id="sliderD" type="range" min="500" max="800" value="760" style="margin-top:12px">
        <div class="muted" style="margin-top:6px">Anbefalt område 500–800 mm</div>
        <div id="miniAngleD" class="miniangle">Vinkel nå: –</div>
      </div>

      <div class="card">
        <div class="muted">Vinkel (grader)</div>
        <div class="big" id="thetaTop">–</div>
      </div>

      <div class="card">
        <label>Tabellbredde (mm rundt D)</label>
        <input id="SPAN" inputmode="numeric" value="60">
        <div id="miniAngleSpan" class="miniangle">Vinkel nå: –</div>
      </div>

      <div class="card">
        <label>Kalibrering (a, b)</label>
        <div class="row">
          <input id="A" value="0.974414" style="width:160px">
          <input id="B" value="21.754" style="width:160px">
        </div>
        <button class="btn" id="apply" style="margin-top:8px">Bruk</button>
        <div class="muted" style="margin-top:6px">Default er flerpunkts-fit fra deres referanser.</div>
        <div id="miniAngleCal" class="miniangle">Vinkel nå: –</div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div style="font-weight:600;margin-bottom:8px">Tabell pr mm rundt D</div>
      <div style="max-height:420px;overflow:auto">
        <table>
          <thead>
            <tr><th style="text-align:left">D (mm)</th><th style="text-align:right">Vinkel (°)</th><th style="text-align:right">D_true (mm)</th><th style="text-align:right">Grader/mm</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section class="out" style="margin-top:12px">
      <div class="card">
        <div class="muted">Grader per mm ved D</div>
        <div class="big" id="slope">–</div>
      </div>
      <div class="card">
        <div class="muted">Justert D_true (mm)</div>
        <div class="big" id="Dtrue">–</div>
      </div>
    </section>

    <div class="footer muted">
      <div><b>Lister Blikk</b> • tlf: 99 44 39 59</div>
      <div>Modell: D_true = a·D + b · θ = 2·asin((D_true−400)/400)</div>
    </div>
  </div>

  <!-- QR MODAL -->
  <div id="qrModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>QR-kode for lenke</h3>
        <button class="close" id="qrClose">Lukk</button>
      </header>
      <div class="row-tight">
        <input id="qrUrl" class="url-input" placeholder="https://">
        <button class="btn" id="qrMake">Lag QR</button>
        <a class="btn" id="qrDownload" download="ts-kalkulator-qr.png" href="#">Last ned PNG</a>
      </div>
      <canvas id="qrCanvas" class="qr-canvas" width="0" height="0"></canvas>
    </div>
  </div>

  <script>
    // ---------- Utils ----------
    const $ = (id) => document.getElementById(id);
    let A = {{ a: 0.974414, b: 21.754 }}; // kalibrering

    function toNumber(v, fb) {{ const n = Number(String(v).replace(',', '.')); return Number.isFinite(n) ? n : fb; }}
    function Dtrue(D) {{ return A.a * D + A.b; }}
    function theta(D) {{
      const Dt = Dtrue(D);
      const x = (Dt - 400) / 400;
      const xx = Math.max(-1, Math.min(1, x));
      return 2 * Math.asin(xx) * 180 / Math.PI;
    }}
    function slope(D) {{
      const Dt = Dtrue(D);
      const x = Dt - 400;
      const cl = Math.max(-399.999999, Math.min(399.999999, x));
      const rad = Math.sqrt(400*400 - cl*cl);
      return (180/Math.PI) * (1 / rad);
    }}

    function updateMiniAngles(Dval){{
      const t = theta(Dval);
      const txt = 'Vinkel nå: ' + (Number.isFinite(t) ? t.toFixed(3) + '°' : '–');
      ['miniAngleD','miniAngleSpan','miniAngleCal'].forEach(id => {{ const el = $(id); if (el) el.textContent = txt; }});
      const top = $('thetaTop'); if (top) top.textContent = Number.isFinite(t) ? t.toFixed(3) : '–';
    }}

    function render(){{
      const D = toNumber($('D').value, 760);
      const SPAN = Math.max(10, toNumber($('SPAN').value, 60));
      $('sliderD').value = String(Math.max(500, Math.min(800, D)));
      updateMiniAngles(D);

      const tbody = $('rows'); tbody.innerHTML='';
      const start = Math.max(500, Math.round(D - SPAN/2));
      const end   = Math.min(800, Math.round(D + SPAN/2));
      for (let x = start; x <= end; x++) {{
        const t = theta(x), s = slope(x), Dt = Dtrue(x);
        const tr = document.createElement('tr');
        if (x === Math.round(D)) tr.className = 'hi';

        const tdD = document.createElement('td'); tdD.style.textAlign='left';
        const dTitle = document.createElement('div'); dTitle.textContent = x + ' mm';
        const dAngleInline = document.createElement('div'); dAngleInline.className='angle-inline'; dAngleInline.textContent='Vinkel: ' + t.toFixed(3) + '°';
        tdD.appendChild(dTitle); tdD.appendChild(dAngleInline);

        const tdAngle = document.createElement('td'); tdAngle.className='col-angle'; tdAngle.style.textAlign='right'; tdAngle.textContent=t.toFixed(3);
        const tdDt = document.createElement('td'); tdDt.style.textAlign='right'; tdDt.textContent=Dt.toFixed(3);
        const tdSlope = document.createElement('td'); tdSlope.style.textAlign='right'; tdSlope.textContent=s.toFixed(5);

        tr.appendChild(tdD); tr.appendChild(tdAngle); tr.appendChild(tdDt); tr.appendChild(tdSlope);
        tbody.appendChild(tr);
      }}

      $('slope').textContent = slope(D).toFixed(5);
      $('Dtrue').textContent = Dtrue(D).toFixed(3);
    }}

    // Inputs
    $('apply').addEventListener('click', () => {{ const aa = toNumber($('A').value, A.a); const bb = toNumber($('B').value, A.b); A = {{ a: aa, b: bb }}; render(); }});
    $('D').addEventListener('input', render);
    $('SPAN').addEventListener('input', render);
    $('sliderD').addEventListener('input', (e)=>{{ $('D').value=e.target.value; render(); }});

    // PWA
    if ('serviceWorker' in navigator) {{ window.addEventListener('load', () => {{ navigator.serviceWorker.register('./sw.js'); render(); }}); }}
    else {{ render(); }}

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{{ e.preventDefault(); deferredPrompt=e; const btn=$('installBtn'); btn.hidden=false; btn.addEventListener('click', async()=>{{ btn.hidden=true; await deferredPrompt.prompt(); deferredPrompt=null; }}); }});

    // ---------- QR (placeholder offline generator) ----------
    function simpleQRMatrix(text){{
      const bytes = Array.from(new TextEncoder().encode(text));
      const size = 41;
      const m = Array.from({{length:size}}, _=>Array(size).fill(0));
      let h = 0; for (const b of bytes) h = (h*131 + b) % 0x7fffffff;
      for (let r=0; r<size; r++) for (let c=0; c<size; c++) {{
        const v = (r*size + c + h) * 1103515245 + 12345;
        m[r][c] = (v >>> 23) & 1;
      }}
      const putFinder = (rr,cc)=>{{ for(let r=0;r<7;r++) for(let c=0;c<7;c++) m[rr+r][cc+c] = (r==0||c==0||r==6||c==6||(r>=2&&r<=4&&c>=2&&c<=4))?1:0; }};
      putFinder(0,0); putFinder(0,size-7); putFinder(size-7,0);
      return m;
    }}
    function drawQR(url){{
      const mat = simpleQRMatrix(url);
      const scale = 6, pad = 2;
      const canvas = document.getElementById('qrCanvas');
      const n = mat.length;
      canvas.width = canvas.height = (n+pad*2)*scale;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#000';
      for(let r=0;r<n;r++) for(let c=0;c<n;c++) if(mat[r][c]) ctx.fillRect((c+pad)*scale,(r+pad)*scale,scale,scale);
      document.getElementById('qrDownload').href = canvas.toDataURL('image/png');
    }}
    document.getElementById('qrBtn').addEventListener('click', ()=>{{ document.getElementById('qrUrl').value=location.href; drawQR(location.href); document.getElementById('qrModal').style.display='flex'; }});
    document.getElementById('qrClose').addEventListener('click', ()=>{{ document.getElementById('qrModal').style.display='none'; }});
    document.getElementById('qrMake').addEventListener('click', ()=>{{ drawQR((document.getElementById('qrUrl').value||'').trim()); }});
  </script>
</body>
</html>
