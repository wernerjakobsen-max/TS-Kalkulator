const $ = (id) => document.getElementById(id);
const CANONICAL = "https://wernerjakobsen-max.github.io/TS-Kalkulator/?v=4.2.1";

/* Data for TS-kalkulator (som 3.9.7b) */
const X = [400,420,430,500,525,533,536,590,594,623,678,718,743,756,767,779,785,791,796,800];
const Y = [0,8,10.5,31,38,41,42,59,60,70,90,107,120,128,135,145,150,157,166,180];

const STR = {
  no:{
    app:"TS-kalkulator",
    sub:"Avlest vinkel på tommestokk omregnet til grader",
    lblD:"Avlest D (mm)",
    range:"måleområde 400-800mm",
    angle:"Vinkel (grader)",
    guide_title:"Bruksanvisning",
    guide:[
      "Utstyr: plast tommestokk 2 m (f.eks. Hultafors), leddbredde ca. 15 mm.",
      "Knekk først 200 mm-leddet til ønsket vinkel (θ).",
      "Knekk deretter leddet ved 400 mm-punktet til 0-hjørnet treffer tommestokken langs kanten.",
      "Les av mm langs kanten (D). Skriv D inn her – du får vinkelen i 200-leddet.",
      "Gyldig område: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"Illustrasjonen viser prinsippet: tommestokken ligger langs kanten. 200 mm-leddet står i vinkel θ. Leddet ved 400 mm bøyes slik at spissen (0-punktet) treffer kanten ved D. Denne D-verdien er kalibrert mot vinkelen θ i 200-leddet.",
    toolChoice:"Velg kalkulator:",
    fall_title:"Fallkalkulator",
    fall_intro:"Legg inn verdi i ett av feltene. Trykk Enter eller klikk utenfor feltet for å oppdatere de andre.",
    fall_percent_label:"Fall i prosent (%)",
    fall_percent_hint:"Eksempel: 2 betyr 2 % fall",
    fall_deg_label:"Fall i grader (°)",
    fall_deg_hint:"Eksempel: 1.145 ≈ 2 % fall",
    fall_ratio_label:"Fallforhold (1 : X)",
    fall_ratio_hint:"Skriv X. Eksempel: 50 for 1:50",
    fall_hl_label:"Høydeforskjell og lengde",
    fall_hl_hint:"Bruk samme strekning. Velg enhet for begge.",
    fall_footer:"Merk: 0 % fall gir uendelig fallforhold (ingen høydeforskjell)."
  },
  en:{
    app:"TS Calculator",
    sub:"Angle from folding ruler reading (mm → degrees)",
    lblD:"Reading D (mm)",
    range:"measuring range 400–800 mm",
    angle:"Angle (degrees)",
    guide_title:"Instructions",
    guide:[
      "Tool: 2 m plastic folding ruler (e.g., Hultafors), joint width ≈ 15 mm.",
      "First bend the 200 mm section to the desired angle (θ).",
      "Then bend the joint at the 400 mm point until the 0-corner meets the ruler edge.",
      "Read D in mm along the edge. Enter D here – you get the angle in the 200 mm section.",
      "Valid range: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"The illustration shows the principle: the ruler lies along the edge. The 200 mm section is at angle θ. The joint at 400 mm is bent so that the tip (0-point) meets the edge at D. This D value is calibrated to the angle θ in the 200 mm section.",
    toolChoice:"Select calculator:",
    fall_title:"Slope calculator",
    fall_intro:"Enter a value in one field. Press Enter or click outside the field to update the others.",
    fall_percent_label:"Slope in percent (%)",
    fall_percent_hint:"Example: 2 means 2% slope",
    fall_deg_label:"Slope in degrees (°)",
    fall_deg_hint:"Example: 1.145 ≈ 2% slope",
    fall_ratio_label:"Slope ratio (1 : X)",
    fall_ratio_hint:"Type X. Example: 50 for 1:50",
    fall_hl_label:"Height difference and length",
    fall_hl_hint:"Use the same run. Choose units for both.",
    fall_footer:"Note: 0% slope gives infinite slope ratio (no height difference)."
  },
  sv:{
    app:"TS-kalkylator",
    sub:"Avläst vinkel på tumstock omräknad till grader",
    lblD:"Avläst D (mm)",
    range:"mätområde 400–800 mm",
    angle:"Vinkel (grader)",
    guide_title:"Bruksanvisning",
    guide:[
      "Utrustning: plasttumstock 2 m (t.ex. Hultafors), led-bredd ca 15 mm.",
      "Vik först 200 mm-ledet till önskad vinkel (θ).",
      "Vik sedan leden vid 400 mm-punkten tills 0-hörnet möter tumstocken längs kanten.",
      "Läs av mm längs kanten (D). Skriv in D här – du får vinkeln i 200-ledet.",
      "Giltigt område: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"Illustrationen visar principen: tumstocken ligger längs kanten. 200 mm-ledet står i vinkel θ. Leddet vid 400 mm böjs så att spetsen (0-punkten) möter kanten vid D. Detta D-värde är kalibrerat mot vinkeln θ i 200-ledet.",
    toolChoice:"Välj kalkylator:",
    fall_title:"Fallkalkylator",
    fall_intro:"Ange ett värde i ett av fälten. Tryck Enter eller klicka utanför fältet för att uppdatera de andra.",
    fall_percent_label:"Fall i procent (%)",
    fall_percent_hint:"Exempel: 2 betyder 2 % fall",
    fall_deg_label:"Fall i grader (°)",
    fall_deg_hint:"Exempel: 1,145 ≈ 2 % fall",
    fall_ratio_label:"Fallförhållande (1 : X)",
    fall_ratio_hint:"Skriv X. Exempel: 50 for 1:50",
    fall_hl_label:"Höjdskillnad och längd",
    fall_hl_hint:"Använd samma sträcka. Välj enhet för båda.",
    fall_footer:"Obs: 0 % fall ger oändligt fallförhållande (ingen höjdskillnad)."
  },
  dk:{
    app:"TS-kalkulator",
    sub:"Aflæst vinkel på tommestok omregnet til grader",
    lblD:"Aflæst D (mm)",
    range:"måleområde 400–800 mm",
    angle:"Vinkel (grader)",
    guide_title:"Brugsvejledning",
    guide:[
      "Udstyr: plasttommestok 2 m (fx Hultafors), led-bredde ca. 15 mm.",
      "Bøj først 200 mm-leddet til ønsket vinkel (θ).",
      "Bøj derefter leddet ved 400 mm-punktet til 0-hjørnet møder tommestokken langs kanten.",
      "Aflæs mm langs kanten (D). Indtast D her – du får vinklen i 200-leddet.",
      "Gyldigt område: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"Illustrationen viser princippet: tommestokken ligger langs kanten. 200 mm-leddet står i vinkel θ. Leddet ved 400 mm bøjes, så spidsen (0-punktet) møder kanten ved D. Dette D er kalibreret imod vinklen θ i 200-leddet.",
    toolChoice:"Vælg lommeregner:",
    fall_title:"Fald-kalkulator",
    fall_intro:"Indtast en værdi i ét felt. Tryk Enter eller klik udenfor feltet for at opdatere de andre.",
    fall_percent_label:"Fald i procent (%)",
    fall_percent_hint:"Eksempel: 2 betyder 2 % fald",
    fall_deg_label:"Fald i grader (°)",
    fall_deg_hint:"Eksempel: 1,145 ≈ 2 % fald",
    fall_ratio_label:"Faldforhold (1 : X)",
    fall_ratio_hint:"Skriv X. F.eks. 50 for 1:50",
    fall_hl_label:"Højde-forskel og længde",
    fall_hl_hint:"Brug samme strækning. Vælg enhed for begge.",
    fall_footer:"Bemærk: 0 % fald giver uendeligt faldforhold (ingen højdeforskel)."
  },
  fi:{
    app:"TS-laskin",
    sub:"Taittomitan lukema muunnettuna asteiksi",
    lblD:"Lukema D (mm)",
    range:"mittausalue 400–800 mm",
    angle:"Kulma (astetta)",
    guide_title:"Käyttöohje",
    guide:[
      "Väline: 2 m muovinen taitettava mitta (esim. Hultafors), nivelleveys n. 15 mm.",
      "Taivuta ensin 200 mm osa haluttuun kulmaan (θ).",
      "Taivuta sitten 400 mm kohdan niveltä, kunnes 0-kulma osuu mittaan reunan kohdalla.",
      "Lue millimetrit reunaa pitkin (D). Syötä D tähän – saat kulman 200 mm osassa.",
      "Sallittu alue: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"Kuva havainnollistaa periaatteen: mitta lepää reunan suuntaisesti. 200 mm osa on kulmassa θ. 400 mm kohdan niveltä taivutetaan, kunnes kärki (0-piste) osuu reunaan kohdassa D. Tämä D-arvo on kalibroitu kulmaan θ 200 mm osassa.",
    toolChoice:"Valitse laskin:",
    fall_title:"Kaato-laskin",
    fall_intro:"Syötä arvo johonkin kenttään. Paina Enter tai klikkaa kentän ulkopuolelle päivittääksesi muut.",
    fall_percent_label:"Kaato prosentteina (%)",
    fall_percent_hint:"Esim.: 2 tarkoittaa 2 % kaatoa",
    fall_deg_label:"Kaato asteina (°)",
    fall_deg_hint:"Esim.: 1,145 ≈ 2 % kaato",
    fall_ratio_label:"Kaatosuhde (1 : X)",
    fall_ratio_hint:"Kirjoita X. Esim.: 50 vastaa 1:50",
    fall_hl_label:"Korkeusero ja pituus",
    fall_hl_hint:"Käytä samaa matkaa. Valitse yksikkö molemmille.",
    fall_footer:"Huom: 0 % kaato antaa äärettömän suhteen (ei korkeuseroa)."
  },
  de:{
    app:"TS-Rechner",
    sub:"Abgelesener Winkel am Gliedermaßstab in Grad",
    lblD:"Ablesung D (mm)",
    range:"Messbereich 400–800 mm",
    angle:"Winkel (Grad)",
    guide_title:"Bedienungsanleitung",
    guide:[
      "Werkzeug: 2-m-Gliedermaßstab aus Kunststoff (z. B. Hultafors), Gelenkbreite ca. 15 mm.",
      "Zuerst 200-mm-Glied auf gewünschten Winkel (θ) biegen.",
      "Dann das Glied bei 400 mm so biegen, bis die 0-mm-Ecke den Maßstab entlang der Kante berührt.",
      "In mm entlang der Kante ablesen (D). Geben Sie D hier ein – Sie erhalten den Winkel im 200-mm-Glied.",
      "Gültiger Bereich: 400–800 mm (400≈0°, 800≈180°)."
    ],
    help_text:"Die Illustration zeigt das Prinzip: Der Maßstab liegt entlang der Kante. Das 200-mm-Glied steht im Winkel θ. Das Glied bei 400 mm wird so gebogen, dass die Spitze (0-Punkt) die Kante bei D berührt. Dieser D-Wert ist auf den Winkel θ im 200-mm-Glied kalibriert.",
    toolChoice:"Rechner wählen:",
    fall_title:"Gefälle-Rechner",
    fall_intro:"Geben Sie einen Wert in ein Feld ein. Drücken Sie Enter oder klicken Sie außerhalb, um die anderen zu aktualisieren.",
    fall_percent_label:"Gefälle in Prozent (%)",
    fall_percent_hint:"Beispiel: 2 bedeutet 2 % Gefälle",
    fall_deg_label:"Gefälle in Grad (°)",
    fall_deg_hint:"Beispiel: 1,145 ≈ 2 % Gefälle",
    fall_ratio_label:"Gefälle-Verhältnis (1 : X)",
    fall_ratio_hint:"X eingeben. Beispiel: 50 für 1:50",
    fall_hl_label:"Höhenunterschied und Länge",
    fall_hl_hint:"Gleiche Strecke verwenden. Einheit für beide wählen.",
    fall_footer:"Hinweis: 0 % Gefälle ergibt ein unendliches Verhältnis (kein Höhenunterschied)."
  }
};

function pchipSlopes(x,y){
  const n = x.length, h = new Array(n-1), d = new Array(n-1);
  for(let i=0;i<n-1;i++){ h[i]=x[i+1]-x[i]; d[i]=(y[i+1]-y[i])/h[i]; }
  const m = new Array(n);
  m[0]=d[0]; m[n-1]=d[n-2];
  for(let i=1;i<n-1;i++){
    if(d[i-1]*d[i]<=0) m[i]=0;
    else{
      const w1=2*h[i]+h[i-1], w2=h[i]+2*h[i-1];
      m[i]=(w1+w2)/(w1/d[i-1]+w2/d[i]);
    }
  }
  for(let i=0;i<n-1;i++){
    if(d[i]===0){ m[i]=0; m[i+1]=0; }
    else{
      const a=m[i]/d[i], b=m[i+1]/d[i], s=a*a+b*b;
      if(s>9){
        const t=3/Math.sqrt(s);
        m[i]=t*a*d[i];
        m[i+1]=t*b*d[i];
      }
    }
  }
  return m;
}

const M = pchipSlopes(X,Y);
function pchipEval(xq){
  const n=X.length;
  if(xq<X[0] || xq>X[n-1]) return null;
  let i=0,j=n-1;
  while(j-i>1){
    const k=(i+j)>>1;
    if(X[k]<=xq) i=k; else j=k;
  }
  const h=X[i+1]-X[i], t=(xq-X[i])/h;
  const h00=(1+2*t)*(1-t)*(1-t),
        h10=t*(1-t)*(1-t),
        h01=t*t*(3-2*t),
        h11=t*t*(t-1);
  return h00*Y[i]+h10*h*M[i]+h01*Y[i+1]+h11*h*M[i+1];
}

const LANG_KEY='ts_lang', DEC_KEY='ts_dec';
const themeEl=document.documentElement, themeKey='ts_theme', themeColorTag=document.getElementById('themeColor');

function applyTheme(v){
  themeEl.setAttribute('data-theme',v);
  try{ localStorage.setItem(themeKey,v); }catch(e){}
  if(themeColorTag) themeColorTag.setAttribute('content',(v==='dark')?'#0b1220':'#00FFFF');
}
function toggleTheme(){
  const cur = themeEl.getAttribute('data-theme') || 'auto';
  applyTheme(cur==='dark'?'light':cur==='light'?'auto':'dark');
}
function setLang(c){
  try{ localStorage.setItem(LANG_KEY,c); }catch(e){}
  applyLang(c);
}
function getLang(){
  try{ return localStorage.getItem(LANG_KEY) || 'no'; }catch(e){ return 'no'; }
}
function getDec(){
  try{ return parseInt(localStorage.getItem(DEC_KEY)||'0',10); }catch(e){ return 0; }
}
function setDec(n){
  try{ localStorage.setItem(DEC_KEY,String(n)); }catch(e){}
  updateDecBtn(); render();
}
function toggleDec(){
  setDec(getDec()===0 ? 1 : 0);
}
function updateDecBtn(){
  const b=$('decBtn');
  if(b) b.textContent = (getDec()===0?'0 des':'1 des');
}
function Fdeg(v){
  const d=getDec();
  return (d===0?Math.round(v):v.toFixed(d))+'°';
}

function applyLang(c){
  const S = (STR[c] || STR.no);
  document.title = S.app || "TS-kalkulator";
  const h_sub=$('h_sub'),
        lbl_D=$('lbl_D'),
        rangeText=$('rangeText'),
        lbl_angle=$('lbl_angle'),
        guide_title=$('guide_title'),
        guide_list=$('guide_list'),
        help_text=$('help_text'),
        toolChoice=$('lbl_toolChoice');

  if(h_sub) h_sub.textContent=S.sub;
  if(lbl_D) lbl_D.textContent=S.lblD;
  if(rangeText) rangeText.textContent=S.range;
  if(lbl_angle) lbl_angle.textContent=S.angle;
  if(guide_title) guide_title.textContent=S.guide_title;
  if(guide_list){
    guide_list.innerHTML='';
    (S.guide||[]).forEach(t=>{
      const li=document.createElement('li');
      li.textContent=t;
      guide_list.appendChild(li);
    });
  }
  if(help_text) help_text.textContent=S.help_text||"";
  if(toolChoice) toolChoice.textContent=S.toolChoice||"Velg kalkulator:";

  // Fallkalkulator-tekster
  const fallTitle=$('fallTitle'),
        fallIntro=$('fallIntro'),
        fallPercentLabel=$('fallPercentLabel'),
        fallPercentHint=$('fallPercentHint'),
        fallDegreesLabel=$('fallDegreesLabel'),
        fallDegreesHint=$('fallDegreesHint'),
        fallRatioLabel=$('fallRatioLabel'),
        fallRatioHint=$('fallRatioHint'),
        fallHLLabel=$('fallHLLabel'),
        fallHLHint=$('fallHLHint'),
        fallFooter=$('fallFooter');

  if(fallTitle) fallTitle.textContent = S.fall_title || "Fallkalkulator";
  if(fallIntro) fallIntro.textContent = S.fall_intro || "";
  if(fallPercentLabel) fallPercentLabel.textContent = S.fall_percent_label || "";
  if(fallPercentHint) fallPercentHint.textContent = S.fall_percent_hint || "";
  if(fallDegreesLabel) fallDegreesLabel.textContent = S.fall_deg_label || "";
  if(fallDegreesHint) fallDegreesHint.textContent = S.fall_deg_hint || "";
  if(fallRatioLabel) fallRatioLabel.textContent = S.fall_ratio_label || "";
  if(fallRatioHint) fallRatioHint.textContent = S.fall_ratio_hint || "";
  if(fallHLLabel) fallHLLabel.textContent = S.fall_hl_label || "";
  if(fallHLHint) fallHLHint.textContent = S.fall_hl_hint || "";
  if(fallFooter) fallFooter.textContent = S.fall_footer || "";
}

/* Dynamisk illustrasjon */
function updateIllustration(deg){
  const tsRoot=$('tsRoot');
  const joint200=$('joint200');
  const joint400=$('joint400');
  const Dinput=$('D');
  if(!tsRoot || !joint200 || !joint400 || !Dinput) return;

  const Dval=parseFloat(String(Dinput.value).replace(',','.'));

  if(!Number.isFinite(deg) || !Number.isFinite(Dval)){
    // Fallback-posisjon
    tsRoot.setAttribute('transform','translate(60,200)');
    joint200.setAttribute('transform','rotate(-65)');
    joint400.setAttribute('transform','translate(200,0) rotate(130)');
    return;
  }

  const thetaDeg = deg;
  const thetaSvgDeg = -thetaDeg;
  const thetaRad = thetaDeg * Math.PI / 180;

  // 200 mm-ledd
  joint200.setAttribute('transform','rotate('+thetaSvgDeg+')');

  // 400 mm-ledd: relativ rotasjon 2θ
  const rel400Deg = 2*thetaDeg;
  joint400.setAttribute('transform','translate(200,0) rotate('+rel400Deg+')');

  // spissens lokale x-koordinat i tsRoot: 400 cos θ
  const tipLocalX = 400 * Math.cos(thetaRad);

  // spissen skal havne på D langs kanten (baseRuler ved x=60)
  const Tx = Dval - tipLocalX;
  tsRoot.setAttribute('transform','translate('+(60+Tx)+',200)');
}

function render(){
  const thetaTop=$('thetaTop'),
        rangeText=$('rangeText'),
        sliderD=$('sliderD'),
        inp=$('D');
  if(!thetaTop||!rangeText||!sliderD||!inp) return;

  const D=parseFloat(String(inp.value).replace(',','.'));
  if(!Number.isFinite(D)){
    thetaTop.textContent='–';
    updateIllustration(NaN);
    return;
  }
  sliderD.value = String(Math.max(400,Math.min(800,D)));
  const deg=pchipEval(D);
  if(deg==null){
    rangeText.classList.add('warn');
    thetaTop.textContent='–';
    updateIllustration(NaN);
  }else{
    rangeText.classList.remove('warn');
    thetaTop.textContent=Fdeg(deg);
    updateIllustration(deg);
  }
}

/* QR-modal */
function openQR(){
  const url=CANONICAL, enc=encodeURIComponent(url);
  const box=$('qrUrlBox'),img=$('qrImg'),a=$('qrDownload'),modal=$('qrModal');
  if(box) box.textContent=url;
  if(img){
    img.src=`https://api.qrserver.com/v1/create-qr-code/?size=512x512&margin=10&data=${enc}`;
  }
  if(a && img) a.href=img.src;
  if(modal) modal.style.display='flex';
}
function closeQR(){
  const m=$('qrModal'); if(m)m.style.display='none';
}
function copyUrl(){
  if(!navigator.clipboard) return;
  navigator.clipboard.writeText(CANONICAL).then(()=>{
    const b=$('copyUrl'); if(!b)return;
    b.textContent='Kopiert!';
    setTimeout(()=>{b.textContent='Kopier lenke';},1200);
  }).catch(()=>{});
}

/* Install (PWA) */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredPrompt=e;
});
async function tryInstall(){
  if(deferredPrompt){
    await deferredPrompt.prompt();
    deferredPrompt=null;
    return;
  }
  const m=$('instModal'); if(m)m.style.display='flex';
}

/* Verktøyvelger: TS / Fall */
function switchTool(tool){
  const ts=$('tool-ts'), fall=$('tool-fall');
  if(!ts||!fall)return;
  if(tool==='fall'){
    ts.style.display='none';
    fall.style.display='block';
  }else{
    ts.style.display='block';
    fall.style.display='none';
  }
}

/* Fallkalkulator – hjelpefunksjoner */
function fallParseInput(id){
  const el=$(id); if(!el)return NaN;
  let raw=el.value.trim(); if(!raw)return NaN;
  raw=raw.replace(",",".");
  return parseFloat(raw);
}
function fallSetNumber(id,value,decimals){
  const el=$(id); if(!el||!isFinite(value))return;
  el.value=value.toFixed(decimals);
}
function fallSetText(id,value){
  const el=$(id); if(!el)return;
  el.value=value;
}

function fallUpdateAll(stigning){
  if(!isFinite(stigning)||stigning<0)return;
  fallSetNumber("fallPercent",stigning*100,3);
  fallSetNumber("fallDegrees",Math.atan(stigning)*180/Math.PI,3);
  if(stigning===0){
    fallSetText("fallRatio","∞");
  }else{
    const ratio=1/stigning;
    fallSetText("fallRatio",ratio.toFixed(3).replace(/\.?0+$/,""));
  }
}

function fallFromPercent(){
  const p=fallParseInput("fallPercent"); if(isNaN(p))return;
  const s=p/100; fallUpdateAll(s);
}
function fallFromDegrees(){
  const d=fallParseInput("fallDegrees"); if(isNaN(d))return;
  const s=Math.tan(d*Math.PI/180); fallUpdateAll(s);
}
function fallFromRatio(){
  const el=$("fallRatio"); if(!el)return;
  let raw=el.value.trim(); if(!raw)return;
  if(raw.indexOf(":")>=0){
    const parts=raw.split(":");
    raw=parts[1]||parts[0];
  }
  raw=raw.replace(",",".");
  const r=parseFloat(raw); if(!isFinite(r)||r<=0)return;
  const s=1/r; fallUpdateAll(s);
}

function unitToMeters(value,unit){
  if(!isFinite(value))return NaN;
  if(unit==="mm")return value/1000;
  if(unit==="cm")return value/100;
  if(unit==="m")return value;
  return NaN;
}

function fallFromHeightLength(){
  const hVal=fallParseInput("fallHeightVal");
  const LVal=fallParseInput("fallLengthVal");
  const hUnitEl=$("fallHeightUnit"), LUnitEl=$("fallLengthUnit");
  const hUnit=hUnitEl?hUnitEl.value:"mm";
  const LUnit=LUnitEl?LUnitEl.value:"m";
  if(isNaN(hVal)||isNaN(LVal))return;
  const hM=unitToMeters(hVal,hUnit);
  const LM=unitToMeters(LVal,LUnit);
  if(!isFinite(hM)||!isFinite(LM)||LM<=0)return;
  const s=hM/LM; fallUpdateAll(s);
}

/* Init */
document.addEventListener('DOMContentLoaded',()=>{
  const langSel=$('lang');
  const cur=getLang();
  if(langSel) langSel.value=cur;
  applyLang(cur);

  if(langSel){
    langSel.addEventListener('change',(e)=>{
      setLang(e.target.value);
    });
  }
  updateDecBtn();

  const decBtn=$('decBtn'); if(decBtn)decBtn.addEventListener('click',toggleDec);
  const themeBtn=$('themeBtn'); if(themeBtn)themeBtn.addEventListener('click',toggleTheme);

  const Dinput=$('D'); if(Dinput)Dinput.addEventListener('input',render);
  const sliderD=$('sliderD'); if(sliderD)sliderD.addEventListener('input',e=>{
    Dinput.value=e.target.value;
    render();
  });

  const qrBtn=$('qrBtn'); if(qrBtn)qrBtn.addEventListener('click',openQR);
  const qrClose=$('qrClose'); if(qrClose)qrClose.addEventListener('click',closeQR);
  const copyBtn=$('copyUrl'); if(copyBtn)copyBtn.addEventListener('click',copyUrl);

  const instBtn=$('installBtn'); if(instBtn)instBtn.addEventListener('click',tryInstall);
  const instClose=$('instClose'); if(instClose)instClose.addEventListener('click',()=>{
    const m=$('instModal'); if(m)m.style.display='none';
  });

  const hardBtn=$('hardRefreshBtn');
  if(hardBtn)hardBtn.addEventListener('click', async ()=>{
    try{
      if('caches' in window){
        const names=await caches.keys();
        await Promise.all(names.map(n=>caches.delete(n)));
      }
      if('serviceWorker' in navigator){
        const regs=await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
    }catch(e){}
    location.href=CANONICAL;
  });

  render();
  const ver=$('ver'); if(ver)ver.textContent='4.2.1';
});

/* Service worker */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js');
  });
}

/* Eksponer funksjoner brukt i inline-onchange */
window.switchTool = switchTool;
window.fallFromPercent = fallFromPercent;
window.fallFromDegrees = fallFromDegrees;
window.fallFromRatio = fallFromRatio;
window.fallFromHeightLength = fallFromHeightLength;
